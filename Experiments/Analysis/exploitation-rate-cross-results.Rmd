# Exploitation rate results

## Analysis dependencies

```{r, message=FALSE}
library(ggplot2)
library(dplyr)
library(plyr)
library(tidyverse)
library(cowplot)
library(reshape2)
source("https://gist.githubusercontent.com/benmarwick/2a1bb0133ff568cbe28d/raw/fb53bd97121f7f9ce947837ef1a4c65a73bffb3f/geom_flat_violin.R")
```

## Setup

Setting up needed variables.

```{r}
# Relative location of data.
working_directory <- "C:/Users/jgh9094/Desktop/Research/Projects/SelectionDiagnostics/Selection-Scheme-Diagnotics-Part-I/"
# theme for plots
cb_palette <- "Dark2"
p_theme <- ggplot2::theme(
  text = element_text(size = 18),
  plot.title = element_text( face = "bold", size = 22, hjust=0.5),
  panel.border = element_blank(),
  panel.grid.minor = element_blank(),
  legend.title=element_text(size=18),
  legend.text=element_text(size=9),
  axis.title = element_text(size=18),
  axis.text = element_text(size=18),
  legend.position="bottom",
  legend.title.align=0.5
)
# Create directory to dump plots
cb_palette <- "Dark2"
TRAITS = 100
tsize = 26
acron = tolower(c('TRU','TOR','GFS','PFS','LEX','NDS','NOV','RAN'))
names = c('Truncation (tru)','Tournament (tor)', 'Genotypic Fitness Sharing (gfs)','Phenotypic Fitness Sharing (pfs)','Lexicase (lex)','Nondominated Sorting (nds)','Novelty Search (nov)','Random (ran)')
```

These analyses were conducted in the following computing environment:

```{r}
print(version)
```

## Performance over time

Here we plot the performance of the best perfoming solution (solution with the greatest aggregate score).

```{r, warning=FALSE}

df <- read.csv('./DataTools/Vizualizor/Together/exploitation-rate-ot-res.csv', header = TRUE, stringsAsFactors = FALSE)
df$`Selection Scheme` <- factor(df$selection, levels = names)

plot <- df %>%
        group_by(`Selection Scheme`, gen) %>%
          dplyr::summarise(
            min = min(pop_fit_max),
            mean = mean(pop_fit_max),
            max = max(pop_fit_max)
          )  %>%
      ggplot(., aes(x=gen, y=mean / TRAITS, group = `Selection Scheme`, fill =`Selection Scheme`, color = `Selection Scheme`)) + # nolint
        geom_ribbon(aes(ymin = min / TRAITS, ymax = max / TRAITS), alpha = 0.1) +
        geom_line(aes(group = `Selection Scheme`, linetype = `Selection Scheme`), alpha = 1.0, size = 1.0) + # nolint
        scale_y_continuous(
          name="Average trait score",
          limits = c(-1, 101),
          breaks=seq(0,100, 20),
          labels = c("0", "20", "40", "60", "80", "100")
        ) +
        scale_x_continuous(
          name="Generations",
          limits = c(0, 50000),
          breaks = c(0, 10000, 20000, 30000, 40000, 50000),
          labels = c("0e+6", "1e+6", "2e+6", "3e+6", "4e+6", "5e+6")

        ) +
        scale_color_brewer(palette = cb_palette, direction = -1) +
        scale_fill_brewer(palette = cb_palette, direction = -1) +
        guides(
          color=guide_legend(nrow=3,title.position = "bottom"),
          fill=guide_legend(nrow=3,title.position = "bottom")
        ) +
        p_theme

plot
```

```{r, echo = FALSE}
legend <- cowplot::get_legend(
  plot +
    guides(
      color=guide_legend(nrow=3,title.position = "bottom"),
      fill=guide_legend(nrow=3,title.position = "bottom")
    ) +
    theme(
      legend.position = "top",
      legend.box="verticle",
      legend.justification="center"
    )
)
```

## Best performance throughout

Here we plot the performance of the best performing solution found throughout an evolutionary.

```{r}
df <- read.csv('./DataTools/Vizualizor/Together/exploitation-rate-best-res.csv', header = TRUE, stringsAsFactors = FALSE)
df$`Selection Scheme` <- factor(df$acron, levels = acron)

# plot data
plot <- ggplot(df, aes(x = `Selection Scheme`, y = val / TRAITS, color = `Selection Scheme`, fill = `Selection Scheme`)) +
  geom_flat_violin(position = position_nudge(x = .2, y = 0), scale = 'width', alpha = 0.5) +
  geom_point(position = position_jitter(width = .1), size = 0.7, alpha = 1.0) +
  geom_boxplot(color = 'black',width = .1, outlier.shape = NA, alpha = 0.0) +
  guides(
          color=guide_legend(nrow=1,title.position = "bottom"),
          fill=guide_legend(nrow=1,title.position = "bottom")
        ) +
  scale_color_brewer(palette=cb_palette,direction=-1) +
  scale_fill_brewer(palette=cb_palette,direction=-1) +
  scale_y_continuous(
    name="Average trait score",
    limits=c(-1, 101),
    breaks=seq(0,100, 20),
    labels=c("0", "20", "40", "60", "80", "100")
  ) +
  scale_x_discrete(
    name="Scheme"
  )+
  p_theme

plot_grid(
  plot +
    theme(legend.position="none"),
  legend,
  nrow=2,
  rel_heights = c(2,1)
) + p_theme

# groups being compared stats
df$`Selection Scheme` <- factor(df$acron, levels = c('tru', 'tor', 'lex', 'gfs', 'pfs', 'nds', 'nov', 'ran'))
group_by(df, `Selection Scheme`) %>%
  dplyr::summarise(
    count = n(),
    na_cnt = sum(is.na(val)),
    min = min(val / TRAITS, na.rm = TRUE),
    median = median(val / TRAITS, na.rm = TRUE),
    mean = mean(val / TRAITS, na.rm = TRUE),
    max = max(val / TRAITS, na.rm = TRUE),
    IQR = IQR(val / TRAITS, na.rm = TRUE)
  )
# stats time
kruskal.test(val ~ `Selection Scheme`,data = df)
# overall differences among those data points that can be tested
pairwise.wilcox.test(x = df$val, g = df$`Selection Scheme`, p.adjust.method = "bonferroni",
                     paired = FALSE, conf.int = FALSE, alternative = 'l')
# no difference between fsg and fsp
wilcox.test(filter(df, `Selection Scheme` == 'gfs')$val, filter(df, `Selection Scheme` == 'pfs')$val, p.adjust.method = "bonferroni",
                     paired = FALSE, conf.int = FALSE, alternative = 't')

```

## Generation satisfactory solution found

```{r}
# tournament
tour = read.csv('./DATA/TOURNAMENT/sf-exploitation-50000-100-99.csv', header = TRUE, stringsAsFactors = FALSE)
colnames(tour) = c(1,2,4,8,16,32,64,128,256,512)
tour = melt(tour, id.vars=c(0))
colnames(tour) = c("parameter", "generation")
rand = subset(tour, parameter == 1)
tour = subset(tour, parameter == 8)
tour$acron = acron[2]

# random
rand$acron = acron[8]

# truncation
tru = read.csv('./DATA/TRUNCATION//sf-exploitation-50000-100-99.csv', header = TRUE, stringsAsFactors = FALSE)
colnames(tru) = c(1,2,4,8,16,32,64,128,256,512)
tru = melt(tru, id.vars=c(0))
colnames(tru) = c("parameter", "generation")
tru = subset(tru, parameter == 8)
tru$acron = acron[1]

# genotypic fitness sharing
fsg = read.csv('./DATA/FITSHARING_G/sf-exploitation-50000-100-99.csv', header = TRUE, stringsAsFactors = FALSE)
colnames(fsg) = c(0.0, 0.1, 0.3, 0.6, 1.2, 2.5, 5.0, 10.0)
fsg = melt(fsg, id.vars=c(0))
colnames(fsg) = c("parameter", "generation")
fsg = subset(fsg, parameter == 0.3)
fsg$acron = acron[3]

# phenotypic fitness sharing
fsp = read.csv('./DATA/FITSHARING_P/sf-exploitation-50000-100-99.csv', header = TRUE, stringsAsFactors = FALSE)
colnames(fsp) = c(0.0, 0.1, 0.3, 0.6, 1.2, 2.5, 5.0, 10.0)
fsp = melt(fsp, id.vars=c(0))
colnames(fsp) = c("parameter", "generation")
fsp = subset(fsp, parameter == 0.3)
fsp$acron = acron[4]

# lexicase
lex = read.csv('./DATA/LEXICASE/sf-exploitation-50000-100-99.csv', header = TRUE, stringsAsFactors = FALSE)
colnames(lex) = c(0.0, 0.1, 0.3, 0.6, 1.2, 2.5, 5.0, 10.0)
lex = melt(lex, id.vars=c(0))
colnames(lex) = c("parameter", "generation")
lex = subset(lex, parameter == 0.0)
lex$acron = acron[5]

# nondominated sorting
nds = read.csv('./DATA/NONDOMINATED/sf-exploitation-50000-100-99.csv', header = TRUE, stringsAsFactors = FALSE)
colnames(nds) = c(0,1,2,4,8,15,30,60)
nds = melt(nds, id.vars=c(0))
colnames(nds) = c("parameter", "generation")
nds = subset(nds, parameter == 8)
nds$acron = acron[6]

# novelty
nov = read.csv('./DATA/NOVELTY/sf-exploitation-50000-100-99.csv', header = TRUE, stringsAsFactors = FALSE)
colnames(nov) = c(0,1,2,4,8,15,30,60)
nov = melt(nov, id.vars=c(0))
colnames(nov) = c("parameter", "generation")
nov = subset(nov, parameter == 8)
nov$acron = acron[7]


# get rid of na's
tour[is.na(tour)] <- 59999
tru[is.na(tru)] <- 59999
fsp[is.na(fsp)] <- 59999
fsg[is.na(fsg)] <- 59999
nov[is.na(nov)] <- 59999
lex[is.na(lex)] <- 59999
nds[is.na(nds)] <- 59999
rand[is.na(rand)] <- 59999

# combine data into one csv
df = rbind(tour,tru,lex,nov,fsg,fsp,nds,rand)
df$`Selection Scheme` <- factor(df$acron, levels = acron)

plot <- ggplot(df, aes(x = `Selection Scheme`, y = generation, color = `Selection Scheme`, fill = `Selection Scheme`)) +
  geom_flat_violin(position = position_nudge(x = .2, y = 0), scale = 'width', alpha = 0.5) +
  geom_point(position = position_jitter(width = .1), size = 0.7, alpha = 1.0) +
  geom_boxplot(color = 'black',width = .1, outlier.shape = NA, alpha = 0.0) +
  guides(
          color=guide_legend(nrow=1,title.position = "bottom"),
          fill=guide_legend(nrow=1,title.position = "bottom")
        ) +
  scale_color_brewer(palette=cb_palette,direction=-1) +
  scale_fill_brewer(palette=cb_palette,direction=-1) +
  scale_y_continuous(
    name="Generation",
    limits=c(0, 60000),
    breaks=c(0, 10000, 20000, 30000, 40000, 50000,60000),
    labels=c("0", "10000", "20000", "30000", "40000", "50000", "Unsolved")
  ) +
  scale_x_discrete(
    name="Scheme"
  )+
  p_theme

plot_grid(
  plot +
    theme(legend.position="none"),
  legend,
  nrow=2,
  rel_heights = c(2,1)
) + p_theme

# groups being compared stats
df$`Selection Scheme` <- factor(df$acron, levels = c('tru', 'tor', 'lex', 'gfs', 'pfs', 'nds', 'nov', 'ran'))
group_by(df, `Selection Scheme`) %>%
  dplyr::summarise(
    count = n(),
    na_cnt = sum(is.na(generation)),
    min = min(generation, na.rm = TRUE),
    median = median(generation, na.rm = TRUE),
    mean = mean(generation, na.rm = TRUE),
    max = max(generation, na.rm = TRUE),
    IQR = IQR(generation, na.rm = TRUE)
  )

# statistics time

# we get p-generationue < 2.2e-16 => we reject the null and assume they come from different distributions
kruskal.test(generation ~ `Selection Scheme`, data = df)

# overall differences among those data points that can be tested
pairwise.wilcox.test(x = df$generation, g = df$`Selection Scheme`, p.adjust.method = "bonferroni",
                     paired = FALSE, conf.int = FALSE, alternative = 'g')
```